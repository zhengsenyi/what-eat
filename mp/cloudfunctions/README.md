# 云函数部署说明

## 概述

本项目使用微信云开发的云函数作为 HTTP 代理，将小程序的请求转发到后端服务器。这样可以解决没有 HTTPS 证书的问题。

## 部署步骤

### 1. 开通云开发

1. 在微信开发者工具中，点击左上角的「云开发」按钮
2. 如果是首次使用，需要开通云开发服务
3. 创建一个云开发环境，记住环境 ID

### 2. 配置环境 ID

在 `mp/app.js` 中，找到 `globalData.cloudEnv`，填入你的云开发环境 ID：

```javascript
globalData: {
  // ...
  cloudEnv: 'your-env-id' // 替换为你的云开发环境ID
}
```

### 3. 部署云函数

1. 在微信开发者工具中，找到 `cloudfunctions` 目录
2. 右键点击 `apiProxy` 文件夹
3. 选择「上传并部署：云端安装依赖（不上传 node_modules）」
4. 等待部署完成

### 4. 配置后端服务器地址

在 `mp/cloudfunctions/apiProxy/index.js` 中，修改 `TARGET_URL` 为你的后端服务器地址：

```javascript
const TARGET_URL = 'http://your-server-ip:port';
```

修改后需要重新部署云函数。

## 切换请求模式

在 `mp/utils/api.js` 中，可以通过修改 `USE_CLOUD_PROXY` 来切换请求模式：

```javascript
// 设置为 true 使用云函数代理
// 设置为 false 使用直接请求（仅用于开发调试，需要在开发者工具中关闭域名校验）
const USE_CLOUD_PROXY = true;
```

## 注意事项

1. 云函数有调用次数限制，请注意控制请求频率
2. 云函数有执行时间限制（默认 3 秒，最长 60 秒），如果后端响应较慢，可能需要调整超时时间
3. 云函数的 `axios` 依赖需要在云端安装，请使用「云端安装依赖」的方式部署
4. 如果遇到问题，可以在云开发控制台查看云函数日志

## 文件说明

- `apiProxy/index.js` - 云函数主文件，负责转发 HTTP 请求
- `apiProxy/package.json` - 云函数依赖配置

## 调试

1. 在微信开发者工具的控制台中可以看到云函数调用的日志
2. 在云开发控制台的「云函数」-「日志」中可以查看详细的执行日志
3. 如果请求失败，检查：
   - 云函数是否部署成功
   - 环境 ID 是否正确
   - 后端服务器是否可访问
   - 后端服务器地址是否正确