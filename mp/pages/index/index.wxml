<wxs module="utils">
  module.exports = {
    getMealTypeName: function(mealType) {
      if (mealType === 1) return 'æ—©é¤';
      if (mealType === 2) return 'åˆé¤';
      if (mealType === 3) return 'æ™šé¤';
      if (mealType === 4) return 'å¤œå®µ';
      return 'ç¾é£Ÿ';
    }
  }
</wxs>

<view class="container-index {{showResult ? 'no-scroll' : ''}}">
  <!-- è‡ªå®šä¹‰å¯¼èˆªæ  - é€‚é…èƒ¶å›Š -->
  <view class="custom-nav" style="padding-top: {{statusBarHeight}}px;">
    <view class="nav-content" style="height: {{navBarHeight}}px;">
      <view class="nav-left">
        <text class="app-logo">ğŸ±</text>
        <text class="app-title">åƒå•¥ç›²ç›’</text>
      </view>
      <!-- å³ä¾§åŒºåŸŸï¼šæˆ‘çš„å…¥å£ + èƒ¶å›Šå ä½ -->
      <view class="nav-right">
        <!-- æˆ‘çš„é¡µé¢å…¥å£ï¼Œç´§æŒ¨èƒ¶å›Šå·¦ä¾§ -->
        <navigator url="/pages/profile/profile" hover-class="none" class="profile-entry">
          <view class="profile-btn" style="height: {{menuButtonHeight}}px; line-height: {{menuButtonHeight}}px;">
            <text class="profile-icon">ğŸ‘¤</text>
          </view>
        </navigator>
        <!-- èƒ¶å›Šå ä½ -->
        <view class="nav-right-placeholder" style="width: {{menuButtonWidth}}px;"></view>
      </view>
    </view>
  </view>

  <!-- ä¸»å†…å®¹åŒºåŸŸ -->
  <view class="main-content">
    <!-- ç›²ç›’åŒºåŸŸ - å æ»¡å‰©ä½™ç©ºé—´å¹¶å±…ä¸­ -->
    <view class="blindbox-area">
      <view class="blindbox-container">
        <!-- æœªæŠ½å¥–çŠ¶æ€ï¼šæ˜¾ç¤ºç›²ç›’ -->
        <view class="blindbox-wrapper" wx:if="{{!showResult}}">
          <view class="blindbox {{isShaking ? 'shake' : ''}} {{isPressed ? 'pressed' : ''}} {{isOpening ? 'opening' : ''}}" 
                bindtap="startDraw"
                bindtouchstart="onBoxTouchStart"
                bindtouchend="onBoxTouchEnd">
            <!-- å…‰æ™•æ•ˆæœ -->
            <view class="blindbox-glow {{isShaking ? 'glow-active' : ''}}"></view>
            <!-- ç²’å­æ•ˆæœ -->
            <view class="particles" wx:if="{{isShaking}}">
              <view class="particle particle-1"></view>
              <view class="particle particle-2"></view>
              <view class="particle particle-3"></view>
              <view class="particle particle-4"></view>
              <view class="particle particle-5"></view>
              <view class="particle particle-6"></view>
            </view>
            <!-- ç›²ç›’ä¸»ä½“ -->
            <view class="blindbox-inner">
              <view class="blindbox-lid {{isOpening ? 'lid-open' : ''}}">
                <view class="lid-ribbon"></view>
              </view>
              <view class="blindbox-body">
                <view class="blindbox-face">
                  <text class="gift-icon">ğŸ</text>
                </view>
              </view>
            </view>
            <!-- é˜´å½± -->
            <view class="blindbox-shadow {{isShaking ? 'shadow-active' : ''}}"></view>
          </view>
          <text class="blindbox-hint">{{isShaking ? 'æ­£åœ¨æŠ½é€‰ä¸­...' : 'ç‚¹å‡»ç›²ç›’å¼€å§‹æŠ½é€‰'}}</text>
          <view class="remaining-times">
            <text class="times-label">ä»Šæ—¥å‰©ä½™</text>
            <text class="times-value">{{remainingTimes}}</text>
            <text class="times-unit">æ¬¡</text>
          </view>
        </view>

        <!-- æŠ½å¥–ç»“æœå±•ç¤º -->
        <view class="result-wrapper" wx:if="{{showResult}}" catchtouchmove="preventTouchMove">
          <view class="result-card {{resultAnimating ? 'result-enter' : ''}}">
            <!-- é£Ÿç‰©å›¾ç‰‡ -->
            <view class="food-image-container">
              <image 
                class="food-image" 
                src="{{foodResult.image_url}}" 
                mode="aspectFill"
                binderror="onImageError"
              />
              <view class="food-badge">
                <text class="badge-text">{{utils.getMealTypeName(foodResult.meal_type)}}</text>
              </view>
            </view>
            <!-- é£Ÿç‰©ä¿¡æ¯ -->
            <view class="food-info">
              <text class="food-name">{{foodResult.name}}</text>
              <view class="food-meta">
                <view class="food-price">
                  <text class="price-symbol">Â¥</text>
                  <text class="price-value">{{foodResult.price}}</text>
                </view>
                <view class="food-category" wx:if="{{foodResult.category}}">
                  <text class="category-text">{{foodResult.category}}</text>
                </view>
              </view>
              <text class="food-description" wx:if="{{foodResult.description}}">{{foodResult.description}}</text>
            </view>
            <!-- æ“ä½œæŒ‰é’® -->
            <view class="result-actions">
              <button class="btn-retry" bindtap="resetDraw">
                <text class="btn-icon">ğŸ”„</text>
                <text>å†æŠ½ä¸€æ¬¡</text>
              </button>
              <button class="btn-accept" bindtap="acceptResult">
                <text class="btn-icon">âœ…</text>
                <text>å°±åƒè¿™ä¸ª</text>
              </button>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨è®¾ç½®åŒºåŸŸ -->
    <view class="bottom-settings">
      <!-- åœºæ™¯é€‰æ‹© -->
      <view class="setting-section">
        <view class="section-header">
          <text class="section-title">ğŸ½ï¸ ç”¨é¤åœºæ™¯</text>
        </view>
        <view class="scene-grid">
          <view 
            wx:for="{{scenes}}" 
            wx:key="id" 
            class="scene-card {{selectedScene === item.id ? 'active' : ''}}"
            bindtap="selectScene"
            data-id="{{item.id}}"
          >
            <text class="scene-icon">{{item.icon}}</text>
            <text class="scene-name">{{item.name}}</text>
          </view>
        </view>
      </view>

      <!-- é¢„ç®—èŒƒå›´ -->
      <view class="setting-section">
        <view class="section-header">
          <text class="section-title">ğŸ’° é¢„ç®—èŒƒå›´</text>
          <view class="budget-badge">
            <text class="budget-value">{{budgetMin}}-{{budgetMax}}å…ƒ</text>
          </view>
        </view>
        
        <!-- è‡ªå®šä¹‰åŒæ»‘å—ç»„ä»¶ -->
        <view class="range-slider-container">
          <view class="range-slider" 
                bindtouchstart="onSliderTouchStart"
                bindtouchmove="onSliderTouchMove"
                bindtouchend="onSliderTouchEnd">
            <!-- æ»‘è½¨èƒŒæ™¯ -->
            <view class="slider-track"></view>
            <!-- é€‰ä¸­åŒºåŸŸ -->
            <view class="slider-range" style="left: {{rangeLeft}}%; width: {{rangeWidth}}%;"></view>
            <!-- å·¦æ»‘å— -->
            <view class="slider-thumb thumb-left" style="left: {{rangeLeft}}%;">
              <view class="thumb-inner"></view>
            </view>
            <!-- å³æ»‘å— -->
            <view class="slider-thumb thumb-right" style="left: {{rangeRight}}%;">
              <view class="thumb-inner"></view>
            </view>
          </view>
          <!-- åˆ»åº¦æ ‡ç­¾ -->
          <view class="slider-labels">
            <text class="label-text">0å…ƒ</text>
            <text class="label-text">100å…ƒ</text>
            <text class="label-text">200å…ƒ</text>
          </view>
        </view>
      </view>

      <!-- å¼€å§‹æŠ½é€‰æŒ‰é’® -->
      <view class="draw-button-container">
        <button class="btn-draw {{isShaking ? 'disabled' : ''}}" bindtap="startDraw" disabled="{{isShaking}}">
          <text class="btn-icon">ğŸ²</text>
          <text class="btn-text">{{isShaking ? 'æŠ½é€‰ä¸­...' : 'å¼€å§‹æŠ½é€‰'}}</text>
        </button>
      </view>
    </view>
  </view>
</view>
